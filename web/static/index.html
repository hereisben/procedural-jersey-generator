<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Jersey DSL – Playground | by Ben Nguyen</title>
    <style>
      :root {
        --gap: 12px;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: system-ui, Arial, sans-serif;
        margin: 0;
        display: grid;
        grid-template-columns: 460px 390px 1fr; /* Presets | Editor | Preview */
        grid-template-areas: "left mid right";
        gap: 0;
        min-height: 100vh;
      }
      .col {
        padding: 16px;
      }
      h2 {
        margin: 8px 0 12px;
      }
      .stack {
        display: grid;
        gap: var(--gap);
        align-content: start;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 12px;
        background: #fff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      label {
        font-size: 13px;
        color: #444;
      }
      input[type="text"],
      input[type="number"],
      select {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 8px;
        min-width: 120px;
        font-size: 14px;
      }
      input[type="color"] {
        width: 48px;
        height: 36px;
        padding: 0;
        border: none;
        background: transparent;
      }
      textarea {
        width: 100%;
        height: 60vh;
        font-family: ui-monospace, Consolas, monospace;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 10px;
        padding: 10px;
      }
      .bar {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      button {
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid #999;
        background: #fafafa;
        cursor: pointer;
      }
      button.primary {
        background: #0d6efd;
        color: #fff;
        border-color: #0d6efd;
      }
      .error {
        color: #b00020;
        white-space: pre-wrap;
        min-height: 20px;
      }
      .right {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      .preview {
        flex: 1;
        border: 1px solid #ccc;
        border-radius: 10px;
        overflow: auto;
        background: #fff;
        min-height: 0;
      }
      .download-bar {
        margin-top: 10px;
        text-align: center;
        padding: 8px 0;
      }
      .muted {
        color: #777;
        font-size: 12px;
      }
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .hidden {
        display: none;
      }
      .args-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .args-row input[type="number"] {
        width: 70px;
      }
      .args-row .muted {
        margin-left: 6px;
        font-size: 12px;
        color: #777;
      }
      .left {
        grid-area: left;
      }
      .mid {
        grid-area: mid;
      }
      .right {
        grid-area: right;
      }
      .site-footer {
        position: fixed;
        right: 12px;
        bottom: 8px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 12px;
        color: #555;
        z-index: 9999;
      }
      @media (max-width: 1200px) {
        body {
          grid-template-columns: 430px 1fr;
          grid-template-areas: "left mid" "left mid" "right right";
        }
        .right {
          grid-column: 1 / -1;
        }
        .preview {
          height: 60vh;
        }
      }
      @media (max-width: 768px) and (min-width: 576.02px) {
        .mid {
          display: none;
        }
        .left {
          display: block;
        }
        body {
          grid-template-columns: 1fr;
          grid-template-areas: "left" "right";
        }
      }
      @media (max-width: 576px) {
        .mid {
          display: block;
        }
        .left {
          display: none;
        }
        body {
          grid-template-columns: 1fr;
          grid-template-areas: "right" "mid";
        }
      }
    </style>
  </head>
  <body>
    <!-- LEFT: PRESETS -->
    <div class="col left stack">
      <h2>Presets</h2>
      <div class="card stack">
        <div class="grid-2">
          <div class="stack">
            <label>Team</label>
            <input
              id="team"
              type="text"
              placeholder="Spartan FC"
              value="Spartan FC"
            />
          </div>
          <div class="stack">
            <label>Player</label>
            <input id="player" type="text" placeholder="BEN" value="BEN" />
          </div>
        </div>

        <div class="grid-2">
          <div class="stack">
            <label>Number</label>
            <input id="number" type="number" min="0" max="99" value="23" />
          </div>
          <div class="stack">
            <label>Sponsor</label>
            <input id="sponsor" type="text" placeholder="SJSU" value="SJSU" />
          </div>
        </div>

        <div class="grid-2">
          <div class="stack">
            <label>Primary</label>
            <div class="row">
              <input id="primary" type="text" value="#E5A823" />
              <input id="primaryPick" type="color" value="#E5A823" />
            </div>
          </div>
          <div class="stack">
            <label>Secondary</label>
            <div class="row">
              <input id="secondary" type="text" value="#0055A2" />
              <input id="secondaryPick" type="color" value="#0055A2" />
            </div>
          </div>
        </div>
        <div class="grid-2">
          <div class="stack">
            <label>Tertiary</label>
            <div class="row">
              <input id="tertiary" type="text" value="#ffffff" />
              <input id="tertiaryPick" type="color" value="#ffffff" />
            </div>
          </div>
          <div class="stack">
            <label>Pattern color (optional)</label>
            <div class="row">
              <input id="patterncolor" type="text" value="#0055A2" />
              <input id="patterncolorPick" type="color" value="#0055A2" />
            </div>
          </div>
        </div>
        <div class="stack">
          <label>Font</label>
          <input id="font" type="text" placeholder="Arial" value="Arial" />
        </div>

        <hr />

        <div class="grid-2">
          <div class="stack">
            <label>Pattern</label>
            <select id="pattern">
              <option value="">(none)</option>
              <option value="stripes" selected>stripes</option>
              <option value="hoops">hoops</option>
              <option value="sash">sash</option>
            </select>
          </div>
          <div id="argBox" class="stack"><!-- dynamic args --></div>
        </div>

        <div class="bar">
          <button style="display: none" id="applyPreset" class="primary">
            Apply preset → Build DSL
          </button>
          <p class="muted">Adjust presets → Watch the jersey update live</p>
        </div>
      </div>
    </div>

    <!-- MIDDLE: EDITOR -->
    <div class="col mid stack">
      <h2>Editor</h2>
      <div class="card stack">
        <div class="bar">
          <button style="display: none" id="renderBtn">Render</button>
          <button class="primary" id="exampleBtn">Load example</button>
        </div>
        <textarea id="src"></textarea>
        <div id="err" class="error"></div>
      </div>
    </div>

    <!-- RIGHT: PREVIEW -->
    <div class="col right stack">
      <h2>Preview</h2>
      <div id="preview" class="preview"></div>
      <div class="bar" style="margin-top: 10px">
        <button class="primary" id="downloadSvg">Download SVG</button>
      </div>
    </div>

    <script>
      const $ = (s) => document.querySelector(s);

      const src = $("#src"),
        err = $("#err"),
        preview = $("#preview"),
        live = $("#live");

      // live always on (still keeps checkbox for UI)
      const liveAlways = true;

      // --- fields
      const team = $("#team"),
        player = $("#player"),
        number = $("#number"),
        font = $("#font"),
        sponsor = $("#sponsor");
      const primary = $("#primary"),
        secondary = $("#secondary"),
        tertiary = $("#tertiary"),
        patterncolor = $("#patterncolor");
      const primaryPick = $("#primaryPick"),
        secondaryPick = $("#secondaryPick"),
        tertiaryPick = $("#tertiaryPick"),
        patterncolorPick = $("#patterncolorPick");
      const patternSel = $("#pattern"),
        argBox = $("#argBox");

      // debounce helper
      function debounce(fn, ms = 80) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), ms);
        };
      }

      // guard to avoid form<->editor infinite loop
      let updating = null; // null | 'form' | 'editor'

      // Pattern args UI
      function renderArgInputs() {
        const value = patternSel.value;
        argBox.innerHTML = "";
        if (!value) return;

        if (value === "stripes") {
          argBox.innerHTML = `
            <label>Args <span>| ${value}(count, thickness)</span></label>
            <div class="row grid-2">
              <input id="argCount" type="number" min="1" max="50" value="7" title="count">
              <input id="argThickness" type="number" min="2" max="120" value="22" title="thickness (px)">
            </div>`;
        } else if (value === "hoops") {
          argBox.innerHTML = `
            <label>Args <span>| ${value}(count, thickness)</span></label>
            <div class="row grid-2">
              <input id="argCount" type="number" min="1" max="50" value="9" title="count">
              <input id="argThickness" type="number" min="2" max="120" value="22" title="thickness (px)">
            </div>`;
        } else if (value === "sash") {
          argBox.innerHTML = `
            <label>Args <span>| sash(angle, width)</span></label>
            <div class="row grid-2">
              <input id="argAngle" type="number" min="0" max="85" value="30" title="angle (deg)">
              <input id="argWidth" type="number" min="10" max="200" value="80" title="width (px)">
            </div>`;
        }
        // wire inputs live
        argBox.querySelectorAll("input").forEach((el) => {
          el.addEventListener("input", () => {
            if (liveAlways || live.checked) applyPresetToDSL();
          });
        });
      }
      patternSel.addEventListener("change", () => {
        renderArgInputs();
        if (liveAlways || live.checked) applyPresetToDSL();
      });
      renderArgInputs();

      // sync color picker <-> text with live apply
      const linkColor = (textEl, pickEl) => {
        const sync = () => {
          if (liveAlways || live.checked) applyPresetToDSL();
        };
        pickEl.addEventListener("input", () => {
          textEl.value = pickEl.value;
          sync();
        });
        textEl.addEventListener("input", () => {
          if (/^#[0-9a-fA-F]{6}$/.test(textEl.value))
            pickEl.value = textEl.value;
          sync();
        });
      };
      linkColor(primary, primaryPick);
      linkColor(secondary, secondaryPick);
      linkColor(tertiary, tertiaryPick);
      linkColor(patterncolor, patterncolorPick);

      // Build DSL from the preset form
      function hex6(s) {
        if (!s) return s;
        s = s.trim();
        if (/^#[0-9a-fA-F]{3}$/.test(s)) {
          return "#" + s[1] + s[1] + s[2] + s[2] + s[3] + s[3];
        }
        return s.toUpperCase();
      }

      function escapeStr(s) {
        return s.replace(/\\/g, "\\\\").replace(/"/g, '\\"');
      }
      function clamp(n, lo, hi) {
        return Math.max(lo, Math.min(hi, n));
      }

      function buildDSLFromForm() {
        const parts = [];
        parts.push("jersey {");

        // sponsor (optional)
        if (sponsor && sponsor.value.trim())
          parts.push(`  sponsor: "${escapeStr(sponsor.value.trim())}";`);

        // team
        if (team.value.trim())
          parts.push(`  team: "${escapeStr(team.value.trim())}";`);

        // colors
        const prim = hex6(primary.value || "#0033AA");
        const sec = hex6(secondary.value || "#FFCC00");
        const ter = hex6(tertiary.value || "#000000");
        parts.push(`  primary: ${prim};`);
        parts.push(`  secondary: ${sec};`);
        parts.push(`  tertiary: ${ter};`);

        const patcol = patterncolor.value.trim();
        if (patcol) parts.push(`  patterncolor: ${hex6(patcol)};`);

        // player/number/font
        if (player.value.trim())
          parts.push(`  player: "${escapeStr(player.value.trim())}";`);
        const num = clamp(parseInt(number.value || "10", 10), 0, 99);
        parts.push(`  number: ${isNaN(num) ? 10 : num};`);
        if (font.value.trim())
          parts.push(`  font: "${escapeStr(font.value.trim())}";`);

        // pattern
        const p = patternSel.value;
        if (p) {
          if (p === "stripes" || p === "hoops") {
            const c = clamp(parseInt($("#argCount")?.value || "7", 10), 1, 50);
            const t = clamp(
              parseInt($("#argThickness")?.value || "18", 10),
              2,
              120
            );
            parts.push(`  pattern: ${p}(${c},${t});`);
          } else if (p === "sash") {
            const a = clamp(parseInt($("#argAngle")?.value || "30", 10), 0, 85);
            const w = clamp(
              parseInt($("#argWidth")?.value || "80", 10),
              10,
              200
            );
            parts.push(`  pattern: sash(${a},${w});`);
          }
        }

        parts.push("}");
        return parts.join("\n");
      }

      // Mini parser to sync Editor -> Presets
      function parseDSL(code) {
        const getStr = (key) =>
          (code.match(new RegExp(key + `\\s*:\\s*"(.*?)"\\s*;`, "i")) ||
            [])[1] ?? null;
        const getHex = (key) =>
          (code.match(
            new RegExp(key + `\\s*:\\s*(#[0-9a-fA-F]{3,6})\\s*;`, "i")
          ) || [])[1] ?? null;
        const getInt = (key) => {
          const m = code.match(new RegExp(key + `\\s*:\\s*(\\d+)\\s*;`, "i"));
          return m ? parseInt(m[1], 10) : null;
        };
        const getPattern = () => {
          const m1 = code.match(
            /pattern\s*:\s*(stripes|hoops)\s*\(\s*(\d+)\s*,\s*(\d+)\s*\)\s*;/i
          );
          if (m1)
            return {
              kind: m1[1].toLowerCase(),
              count: +m1[2],
              thickness: +m1[3],
            };
          const m2 = code.match(
            /pattern\s*:\s*sash\s*\(\s*(\d+)\s*,\s*(\d+)\s*\)\s*;/i
          );
          if (m2) return { kind: "sash", angle: +m2[1], width: +m2[2] };
          return { kind: "" };
        };
        return {
          team: getStr("team"),
          player: getStr("player"),
          sponsor: getStr("sponsor"),
          font: getStr("font"),
          number: getInt("number"),
          primary: getHex("primary"),
          secondary: getHex("secondary"),
          tertiary: getHex("tertiary"),
          patterncolor: getHex("patterncolor"),
          pattern: getPattern(),
        };
      }

      function setFormFromAST(ast) {
        if (ast.team !== null) team.value = ast.team;
        if (ast.player !== null) player.value = ast.player;
        if (ast.sponsor !== null && $("#sponsor"))
          $("#sponsor").value = ast.sponsor;
        if (ast.font !== null) font.value = ast.font;
        if (Number.isInteger(ast.number)) number.value = String(ast.number);

        if (ast.primary) {
          primary.value = hex6(ast.primary);
          primaryPick.value = hex6(ast.primary);
        }
        if (ast.secondary) {
          secondary.value = hex6(ast.secondary);
          secondaryPick.value = hex6(ast.secondary);
        }
        if (ast.tertiary) {
          tertiary.value = hex6(ast.tertiary);
          tertiaryPick.value = hex6(ast.tertiary);
        }
        if (ast.patterncolor) {
          patterncolor.value = hex6(ast.patterncolor);
          patterncolorPick.value = hex6(ast.patterncolor);
        }

        patternSel.value = ast.pattern.kind || "";
        renderArgInputs();
        if (ast.pattern.kind === "stripes" || ast.pattern.kind === "hoops") {
          $("#argCount") &&
            ($("#argCount").value = ast.pattern.count ?? $("#argCount").value);
          $("#argThickness") &&
            ($("#argThickness").value =
              ast.pattern.thickness ?? $("#argThickness").value);
        } else if (ast.pattern.kind === "sash") {
          $("#argAngle") &&
            ($("#argAngle").value = ast.pattern.angle ?? $("#argAngle").value);
          $("#argWidth") &&
            ($("#argWidth").value = ast.pattern.width ?? $("#argWidth").value);
        }
      }

      function applyPresetToDSL() {
        updating = "form";
        const code = buildDSLFromForm();
        src.value = code;
        tryRender();
        updating = null;
      }

      const editorToForm = debounce(() => {
        if (updating) return;
        updating = "editor";
        const ast = parseDSL(src.value || "");
        setFormFromAST(ast);
        tryRender();
        updating = null;
      }, 80);

      // wire generic preset inputs
      ["#team", "#player", "#font", "#sponsor", "#number"].forEach((sel) => {
        const el = document.querySelector(sel);
        if (el)
          el.addEventListener("input", () => {
            if (liveAlways || live.checked) applyPresetToDSL();
          });
      });

      $("#applyPreset").onclick = applyPresetToDSL;
      $("#renderBtn").onclick = () => tryRender();

      const EXAMPLE = `jersey {
  team: "Spartan FC";
  primary: #E5A823;
  secondary: #0055A2;
  tertiary: #ffffff;
  patterncolor: #0055A2;
  player: "BEN";
  number: 23;
  sponsor: "SJSU";
  font: "Arial";
  pattern: stripes(7,22);
}`;

      $("#exampleBtn").onclick = () => {
        src.value = EXAMPLE;
        editorToForm();
      };

      // Editor input -> Presets + Preview
      src.addEventListener("input", editorToForm);

      function tryRender() {
        err.textContent = "";
        fetch("/api/render", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ source: src.value }),
        })
          .then((r) => r.json())
          .then((j) => {
            if (!j.ok) {
              err.textContent = j.error || "Unknown error";
              preview.innerHTML = "";
              return;
            }
            const blob = new Blob([j.svg], { type: "image/svg+xml" });
            const url = URL.createObjectURL(blob);
            preview.innerHTML = `<object data="${url}" type="image/svg+xml" style="width:100%;height:100%"></object>`;
            preview.dataset.url = url;
          })
          .catch((e) => (err.textContent = String(e)));
      }

      $("#downloadSvg").onclick = () => {
        const url = preview.dataset.url;
        if (!url) return;
        const a = document.createElement("a");
        a.href = url;
        a.download = "jersey.svg";
        a.click();
      };

      // initial load: preset -> DSL -> render (no loop)
      updating = "form";
      src.value = buildDSLFromForm();
      tryRender();
      updating = null;
    </script>

    <div class="site-footer">
      © 2025 Ben Nguyen — Procedural Jersey Generator
    </div>
  </body>
</html>
