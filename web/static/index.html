<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Jersey DSL – Playground | by Ben Nguyen</title>
    <style>
      :root {
        --gap: 12px;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif, system-ui;
        margin: 0;
        display: grid;
        grid-template-columns: 460px 390px 1fr; /* Presets | Editor | Preview */
        grid-template-areas: "left mid right";
        gap: 0;
        min-height: 100vh;
      }
      .col {
        padding: 16px;
      }
      h2 {
        margin: 8px 0 12px;
      }
      .stack {
        display: grid;
        gap: var(--gap);
        align-content: start;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 12px;
        background: #fff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      label {
        font-size: 13px;
        color: #444;
      }
      input[type="text"],
      input[type="number"],
      select {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 8px;
        min-width: 80px;
        font-size: 14px;
      }
      input[type="color"] {
        width: 48px;
        height: 36px;
        padding: 0;
        border: none;
        background: transparent;
      }
      textarea {
        width: 100%;
        font-family: ui-monospace, Consolas, monospace;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 10px;
        padding: 10px;
      }
      .bar {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      button {
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid #999;
        background: #fafafa;
        cursor: pointer;
      }
      button.primary {
        background: #0d6efd;
        color: #fff;
        border-color: #0d6efd;
      }
      .error {
        color: #b00020;
        white-space: pre-wrap;
        min-height: 20px;
      }
      .right {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      .preview {
        flex: 1;
        border: 1px solid #ccc;
        border-radius: 10px;
        overflow: auto;
        background: #fff;
        min-height: 0;
      }
      .download-bar {
        margin-top: 10px;
        text-align: center;
        padding: 8px 0;
      }
      .muted {
        color: #777;
        font-size: 12px;
      }
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .grid-4 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 10px;
      }
      .grid-8 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
        gap: 10px;
      }
      .hidden {
        display: none;
      }
      .args-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .args-row input[type="number"] {
        width: 70px;
      }
      .args-row .muted {
        margin-left: 6px;
        font-size: 12px;
        color: #777;
      }
      .left {
        grid-area: left;
      }
      .mid {
        grid-area: mid;
      }
      .right {
        grid-area: right;
      }
      .right,
      .left {
        position: sticky;
        top: 0;
        align-self: start;
      }
      .site-footer {
        position: fixed;
        right: 12px;
        bottom: 8px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 12px;
        color: #555;
        z-index: 9999;
      }
      #ai-suggestion-text {
        font-size: 13px;
        line-height: 1.5;
        min-height: 100px;
        background: #f7f7f7;
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        white-space: pre-wrap;
        border: 1px solid #ddd;
      }
      @media (max-width: 1200px) {
        body {
          grid-template-columns: 430px 1fr;
          grid-template-areas: "left mid" "left mid" "right right";
        }
        .right {
          grid-column: 1 / -1;
        }
        .preview {
          height: 60vh;
        }
      }
      @media (max-width: 768px) and (min-width: 576.02px) {
        .mid {
          display: none;
        }
        .left {
          display: block;
        }
        body {
          grid-template-columns: 1fr;
          grid-template-areas: "left" "right";
        }
      }
      @media (max-width: 576px) {
        .mid {
          display: block;
        }
        .left {
          display: none;
        }
        body {
          grid-template-columns: 1fr;
          grid-template-areas: "right" "mid";
        }
      }
    </style>
  </head>
  <body>
    <!-- LEFT: PRESETS -->
    <div class="col left stack">
      <h2>Presets</h2>
      <div class="card stack">
        <div class="grid-2">
          <div class="stack">
            <label>Team</label>
            <input
              id="team"
              type="text"
              placeholder="Spartan FC"
              value="Spartan FC"
            />
          </div>
          <div class="stack">
            <label>Player</label>
            <input id="player" type="text" placeholder="BEN" value="BEN" />
          </div>
        </div>

        <div class="grid-2">
          <div class="stack">
            <label>Number</label>
            <input id="number" type="number" min="0" max="99" value="23" />
          </div>
          <div class="stack">
            <label>Sponsor</label>
            <input id="sponsor" type="text" placeholder="SJSU" value="SJSU" />
          </div>
        </div>

        <div class="grid-2">
          <div class="stack">
            <label>Primary (shirt)</label>
            <div class="row">
              <input id="primary" type="text" value="#E5A823" />
              <input id="primaryPick" type="color" value="#E5A823" />
            </div>
          </div>
          <div class="stack">
            <label>Secondary (short)</label>
            <div class="row">
              <input id="secondary" type="text" value="#0055A2" />
              <input id="secondaryPick" type="color" value="#0055A2" />
            </div>
          </div>
        </div>

        <div class="grid-2">
          <div class="stack">
            <label>Tertiary</label>
            <div class="row">
              <input id="tertiary" type="text" value="#ffffff" />
              <input id="tertiaryPick" type="color" value="#ffffff" />
            </div>
          </div>
          <div class="stack">
            <label>Pattern color</label>
            <div class="row">
              <input id="pattern_color" type="text" value="#0055A2" />
              <input id="patterncolorPick" type="color" value="#0055A2" />
            </div>
          </div>
        </div>

        <div class="stack">
          <label>Font Family</label>
          <input
            id="font"
            type="text"
            placeholder="Sport Scholars Outline"
            value="Sport Scholars Outline"
          />
        </div>

        <div class="stack">
          <label
            >Font Size (Player Name, Number, Team Name, Sponsor Name)</label
          >
          <div class="grid-4">
            <input
              id="player_size"
              type="number"
              min="8"
              max="100"
              value="26"
            />
            <input
              id="number_size"
              type="number"
              min="8"
              max="100"
              value="75"
            />
            <input id="team_size" type="number" min="8" max="100" value="18" />
            <input
              id="sponsor_size"
              type="number"
              min="8"
              max="100"
              value="35"
            />
          </div>
        </div>

        <div class="grid-2">
          <div class="stack">
            <label>Player Name Coordinates (x, y)</label>
            <div class="grid-2">
              <input
                id="player_x"
                type="number"
                min="0"
                max="500"
                value="365"
              />
              <input id="player_y" type="number" min="0" max="500" value="85" />
            </div>
          </div>
          <div class="stack">
            <label>Number Coordinates (x, y)</label>
            <div class="grid-2">
              <input
                id="number_x"
                type="number"
                min="0"
                max="500"
                value="365"
              />
              <input
                id="number_y"
                type="number"
                min="0"
                max="500"
                value="155"
              />
            </div>
          </div>
        </div>

        <div class="grid-2">
          <div class="stack">
            <label>Team Name Coordinates (x, y)</label>
            <div class="grid-2">
              <input id="team_x" type="number" min="0" max="500" value="365" />
              <input id="team_y" type="number" min="0" max="500" value="190" />
            </div>
          </div>
          <div class="stack">
            <label>Sponsor Name Coordinates (x, y)</label>
            <div class="grid-2">
              <input
                id="sponsor_x"
                type="number"
                min="0"
                max="500"
                value="115"
              />
              <input
                id="sponsor_y"
                type="number"
                min="0"
                max="500"
                value="125"
              />
            </div>
          </div>
        </div>

        <div class="grid-2">
          <div class="stack">
            <label>Pattern</label>
            <select id="pattern">
              <option value="">(none)</option>
              <option value="stripes" selected>stripes</option>
              <option value="hoops">hoops</option>
              <option value="sash">sash</option>
              <option value="checker">checker</option>
              <option value="gradient">gradient</option>
            </select>
          </div>
          <div id="argBox" class="stack"><!-- dynamic args --></div>
        </div>

        <div class="bar">
          <button style="display: none" id="applyPreset" class="primary">
            Apply preset → Build DSL
          </button>
          <p class="muted">Adjust presets → Watch the jersey update live</p>
        </div>
      </div>
    </div>

    <!-- MIDDLE: EDITOR -->
    <div class="col mid stack">
      <h2>Editor</h2>

      <!-- DSL Editor -->
      <div class="card stack">
        <div class="bar">
          <button style="display: none" id="renderBtn">Render</button>
          <button class="primary" id="exampleBtn">Load example</button>
        </div>
        <textarea id="src" rows="12"></textarea>
        <div id="err" class="error"></div>
      </div>

      <!-- AI Jersey Chat -->
      <div class="card stack" id="ai-chat-panel">
        <div class="bar" style="justify-content: space-between; width: 100%">
          <h3 style="margin: 0">AI Jersey Chat</h3>
          <span id="ai-status" class="muted"></span>
        </div>

        <div class="stack">
          <label for="ai-message">Describe your jersey idea:</label>
          <textarea
            id="ai-message"
            rows="3"
            placeholder="Example: make a Juventus away kit with black stripes and gold accents"
            style="width: 100%; margin: 0.5rem 0"
          ></textarea>

          <button
            id="ai-generate-btn"
            class="primary"
            style="align-self: flex-start"
          >
            Generate from AI
          </button>
        </div>

        <div class="stack" style="margin-top: 1rem">
          <label for="ai-suggestion-text" class="muted"
            >AI suggestion summary:</label
          >
          <div id="ai-suggestion-text"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: PREVIEW -->
    <div class="col right stack">
      <h2>Preview</h2>
      <div id="preview" class="preview"></div>
      <div class="bar" style="margin-top: 10px">
        <button class="primary" id="downloadSvg">Download SVG</button>
      </div>
    </div>

    <script>
      const $ = (s) => document.querySelector(s);

      const src = $("#src"),
        err = $("#err"),
        preview = $("#preview");

      // --- fields
      const team = $("#team"),
        player = $("#player"),
        number = $("#number"),
        font = $("#font"),
        sponsor = $("#sponsor");
      const teamX = $("#team_x"),
        teamY = $("#team_y"),
        playerX = $("#player_x"),
        playerY = $("#player_y"),
        numberX = $("#number_x"),
        numberY = $("#number_y"),
        sponsorX = $("#sponsor_x"),
        sponsorY = $("#sponsor_y");
      const primary = $("#primary"),
        secondary = $("#secondary"),
        tertiary = $("#tertiary"),
        patterncolor = $("#pattern_color");
      const primaryPick = $("#primaryPick"),
        secondaryPick = $("#secondaryPick"),
        tertiaryPick = $("#tertiaryPick"),
        patterncolorPick = $("#patterncolorPick");
      const patternSel = $("#pattern"),
        argBox = $("#argBox");
      const playerSize = $("#player_size"),
        numberSize = $("#number_size"),
        teamSize = $("#team_size"),
        sponsorSize = $("#sponsor_size");

      // debounce helper
      function debounce(fn, ms = 80) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), ms);
        };
      }

      // guard to avoid form<->editor infinite loop
      let updating = null; // null | 'form' | 'editor'

      // Pattern args UI
      function renderArgInputs() {
        const value = patternSel.value;
        argBox.innerHTML = "";
        if (!value) return;

        if (value === "stripes") {
          argBox.innerHTML = `
            <label>Args <span>| (count, thickness)</span></label>
            <div class="row grid-2">
              <input id="argCount" type="number" min="1" max="50" value="7" title="count">
              <input id="argThickness" type="number" min="2" max="120" value="22" title="thickness (px)">
            </div>`;
        } else if (value === "hoops") {
          argBox.innerHTML = `
            <label>Args <span>| (count, thickness)</span></label>
            <div class="row grid-2">
              <input id="argCount" type="number" min="1" max="50" value="9" title="count">
              <input id="argThickness" type="number" min="2" max="120" value="22" title="thickness (px)">
            </div>`;
        } else if (value === "sash") {
          argBox.innerHTML = `
            <label>Args <span>| (angle, width)</span></label>
            <div class="row grid-2">
              <input id="argAngle" type="number" min="0" max="85" value="30" title="angle (deg)">
              <input id="argWidth" type="number" min="10" max="200" value="80" title="width (px)">
            </div>`;
        } else if (value === "checker") {
          argBox.innerHTML = `
            <label>Args <span>| (width, height)</span></label>
            <div class="row grid-2">
              <input id="argCellWidth" type="number" min="5" max="200" value="30" title="cell width (px)">
              <input id="argCellHeight" type="number" min="5" max="200" value="30" title="cell height (px)">
            </div>`;
        } else if (value === "gradient") {
          argBox.innerHTML = `
            <label>Args <span>| (direction, intensity)</span></label>
            <div class="row grid-2">
              <select id="argDirection">
                <option value="center">center</option>
                <option value="down" selected>down</option>
                <option value="up">up</option>
              </select>
              <input id="argIntensity" type="number" min="10" max="200" value="80" title="intensity (px)">
            </div>`;
        }

        // wire inputs live
        argBox.querySelectorAll("input, select").forEach((el) => {
          ["input", "change"].forEach((evt) => {
            el.addEventListener(evt, () => {
              applyPresetToDSL();
            });
          });
        });
      }

      patternSel.addEventListener("change", () => {
        renderArgInputs();
        applyPresetToDSL();
      });
      renderArgInputs();

      // sync color picker <-> text with live apply
      const linkColor = (textEl, pickEl) => {
        const sync = () => {
          applyPresetToDSL();
        };
        pickEl.addEventListener("input", () => {
          textEl.value = pickEl.value;
          sync();
        });
        textEl.addEventListener("input", () => {
          if (/^#[0-9a-fA-F]{6}$/.test(textEl.value)) {
            pickEl.value = textEl.value;
          }
          sync();
        });
      };
      linkColor(primary, primaryPick);
      linkColor(secondary, secondaryPick);
      linkColor(tertiary, tertiaryPick);
      linkColor(patterncolor, patterncolorPick);

      // Build DSL from the preset form
      function hex6(s) {
        if (!s) return s;
        s = s.trim();
        if (/^#[0-9a-fA-F]{3}$/.test(s)) {
          return "#" + s[1] + s[1] + s[2] + s[2] + s[3] + s[3];
        }
        return s.toUpperCase();
      }

      function escapeStr(s) {
        return s.replace(/\\/g, "\\\\").replace(/"/g, '\\"');
      }

      function clamp(n, lo, hi) {
        if (!Number.isFinite(n)) n = lo;
        return Math.max(lo, Math.min(hi, n));
      }

      function buildDSLFromForm() {
        const parts = [];
        parts.push("jersey {");

        // colors
        const prim = hex6(primary.value || "#0033AA");
        const sec = hex6(secondary.value || "#FFCC00");
        const ter = hex6(tertiary.value || "#000000");
        parts.push(`  primary: ${prim};`);
        parts.push(`  secondary: ${sec};`);
        parts.push(`  tertiary: ${ter};`);

        const patcol = patterncolor.value.trim();
        if (patcol) parts.push(`  pattern_color: ${hex6(patcol)};`);

        // font
        if (font.value.trim()) {
          parts.push(`  font: "${escapeStr(font.value.trim())}";`);
        }

        // sizes
        const playerSizeValue = clamp(
          parseInt(playerSize.value || "26", 10),
          8,
          100
        );
        const numberSizeValue = clamp(
          parseInt(numberSize.value || "75", 10),
          8,
          100
        );
        const teamSizeValue = clamp(
          parseInt(teamSize.value || "18", 10),
          8,
          100
        );
        const sponsorSizeValue = clamp(
          parseInt(sponsorSize.value || "35", 10),
          8,
          100
        );

        // coords
        const px = clamp(parseInt(playerX.value || "365", 10), 0, 1000);
        const py = clamp(parseInt(playerY.value || "85", 10), 0, 1000);
        const nx = clamp(parseInt(numberX.value || "365", 10), 0, 1000);
        const ny = clamp(parseInt(numberY.value || "155", 10), 0, 1000);
        const tx = clamp(parseInt(teamX.value || "365", 10), 0, 1000);
        const ty = clamp(parseInt(teamY.value || "190", 10), 0, 1000);
        const sx = clamp(parseInt(sponsorX.value || "115", 10), 0, 1000);
        const sy = clamp(parseInt(sponsorY.value || "125", 10), 0, 1000);

        // team
        if (team.value.trim()) {
          parts.push(
            `  team: "${escapeStr(
              team.value.trim()
            )}", (${tx}, ${ty}), ${teamSizeValue};`
          );
        }

        // player
        if (player.value.trim()) {
          parts.push(
            `  player: "${escapeStr(
              player.value.trim()
            )}", (${px}, ${py}), ${playerSizeValue};`
          );
        }

        // number
        const numRaw = parseInt(number.value || "23", 10);
        const numValue = isNaN(numRaw) ? 23 : clamp(numRaw, 0, 99);
        parts.push(
          `  number: ${numValue}, (${nx}, ${ny}), ${numberSizeValue};`
        );

        // sponsor (optional)
        if (sponsor && sponsor.value.trim()) {
          parts.push(
            `  sponsor: "${escapeStr(
              sponsor.value.trim()
            )}", (${sx}, ${sy}), ${sponsorSizeValue};`
          );
        }

        // pattern
        const p = patternSel.value;
        if (p) {
          if (p === "stripes" || p === "hoops") {
            const c = clamp(parseInt($("#argCount")?.value || "7", 10), 1, 50);
            const t = clamp(
              parseInt($("#argThickness")?.value || "18", 10),
              2,
              120
            );
            parts.push(`  pattern: ${p}(${c},${t});`);
          } else if (p === "sash") {
            const a = clamp(parseInt($("#argAngle")?.value || "30", 10), 0, 85);
            const w = clamp(
              parseInt($("#argWidth")?.value || "80", 10),
              10,
              200
            );
            parts.push(`  pattern: sash(${a},${w});`);
          } else if (p === "checker") {
            let cwRaw = parseInt($("#argCellWidth")?.value || "30", 10);
            let chRaw = parseInt($("#argCellHeight")?.value || "30", 10);

            if (!Number.isFinite(cwRaw)) cwRaw = 30;
            if (!Number.isFinite(chRaw)) chRaw = 30;

            const cw = clamp(cwRaw, 5, 200);
            const ch = clamp(chRaw, 5, 200);

            parts.push(`  pattern: checker(${cw},${ch});`);
          } else if (p === "gradient") {
            let d = $("#argDirection")?.value.trim() || "center";
            let iRaw = parseInt($("#argIntensity")?.value || "30", 10);

            if (!Number.isFinite(iRaw)) iRaw = 30;

            const i = clamp(iRaw, 10, 200);

            parts.push(`  pattern: gradient("${d}",${i});`);
          }
        }

        parts.push("}");
        return parts.join("\n");
      }

      // Mini parser to sync Editor -> Presets
      function parseDSL(code) {
        const getStr = (key) =>
          (code.match(new RegExp(key + `\\s*:\\s*"(.*?)"\\s*;`, "i")) ||
            [])[1] ?? null;
        const getHex = (key) =>
          (code.match(
            new RegExp(key + `\\s*:\\s*(#[0-9a-fA-F]{3,6})\\s*;`, "i")
          ) || [])[1] ?? null;

        const getPattern = () => {
          const m1 = code.match(
            /pattern\s*:\s*(stripes|hoops)\s*\(\s*(\d+)\s*,\s*(\d+)\s*\)\s*;/i
          );
          if (m1)
            return {
              kind: m1[1].toLowerCase(),
              count: +m1[2],
              thickness: +m1[3],
            };
          const m2 = code.match(
            /pattern\s*:\s*sash\s*\(\s*(\d+)\s*,\s*(\d+)\s*\)\s*;/i
          );
          if (m2) return { kind: "sash", angle: +m2[1], width: +m2[2] };
          const m3 = code.match(
            /pattern\s*:\s*checker\s*\(\s*(\d+)\s*,\s*(\d+)\s*\)\s*;/i
          );
          if (m3) {
            return {
              kind: "checker",
              cellWidth: +m3[1],
              cellHeight: +m3[2],
            };
          }
          const m4 = code.match(
            /pattern\s*:\s*gradient\s*\(\s*"([^"]+)"\s*,\s*(\d+)\s*\)\s*;/i
          );
          if (m4) {
            return {
              kind: "gradient",
              direction: m4[1],
              intensity: +m4[2],
            };
          }
          return { kind: "" };
        };

        function parseTextPlacement(key) {
          const regex = new RegExp(
            key +
              '\\s*:\\s*"(.*?)"\\s*,\\s*\\(\\s*(\\d+)\\s*,\\s*(\\d+)\\s*\\)\\s*,\\s*(\\d+)\\s*;',
            "i"
          );
          const m = code.match(regex);
          if (!m) return null;
          return {
            text: m[1],
            x: parseInt(m[2], 10),
            y: parseInt(m[3], 10),
            size: parseInt(m[4], 10),
          };
        }

        function parseNumberPlacement() {
          const regex =
            /number\s*:\s*(\d+)\s*,\s*\(\s*(\d+)\s*,\s*(\d+)\s*\)\s*,\s*(\d+)\s*;/i;
          const m = code.match(regex);
          if (!m) return null;
          return {
            value: parseInt(m[1], 10),
            x: parseInt(m[2], 10),
            y: parseInt(m[3], 10),
            size: parseInt(m[4], 10),
          };
        }

        return {
          team: parseTextPlacement("team"),
          player: parseTextPlacement("player"),
          sponsor: parseTextPlacement("sponsor"),
          font: getStr("font"),
          number: parseNumberPlacement(),
          primary: getHex("primary"),
          secondary: getHex("secondary"),
          tertiary: getHex("tertiary"),
          pattern_color: getHex("pattern_color"),
          pattern: getPattern(),
        };
      }

      function setFormFromAST(ast) {
        if (ast.team !== null) {
          team.value = ast.team.text;
          if (teamX) teamX.value = ast.team.x;
          if (teamY) teamY.value = ast.team.y;
          if (teamSize) teamSize.value = ast.team.size;
        }
        if (ast.number) {
          number.value = String(ast.number.value);
          if (numberX) numberX.value = ast.number.x;
          if (numberY) numberY.value = ast.number.y;
          if (numberSize) numberSize.value = ast.number.size;
        }
        if (ast.player) {
          player.value = ast.player.text;
          if (playerX) playerX.value = ast.player.x;
          if (playerY) playerY.value = ast.player.y;
          if (playerSize) playerSize.value = ast.player.size;
        }
        if (ast.sponsor) {
          if (sponsor) sponsor.value = ast.sponsor.text;
          if (sponsorX) sponsorX.value = ast.sponsor.x;
          if (sponsorY) sponsorY.value = ast.sponsor.y;
          if (sponsorSize) sponsorSize.value = ast.sponsor.size;
        }
        if (ast.font !== null) font.value = ast.font;

        if (ast.primary) {
          const v = hex6(ast.primary);
          primary.value = v;
          primaryPick.value = v;
        }
        if (ast.secondary) {
          const v = hex6(ast.secondary);
          secondary.value = v;
          secondaryPick.value = v;
        }
        if (ast.tertiary) {
          const v = hex6(ast.tertiary);
          tertiary.value = v;
          tertiaryPick.value = v;
        }
        if (ast.pattern_color) {
          const v = hex6(ast.pattern_color);
          patterncolor.value = v;
          patterncolorPick.value = v;
        }

        patternSel.value = ast.pattern.kind || "";
        renderArgInputs();
        if (ast.pattern.kind === "stripes" || ast.pattern.kind === "hoops") {
          $("#argCount") &&
            ($("#argCount").value = ast.pattern.count ?? $("#argCount").value);
          $("#argThickness") &&
            ($("#argThickness").value =
              ast.pattern.thickness ?? $("#argThickness").value);
        } else if (ast.pattern.kind === "sash") {
          $("#argAngle") &&
            ($("#argAngle").value = ast.pattern.angle ?? $("#argAngle").value);
          $("#argWidth") &&
            ($("#argWidth").value = ast.pattern.width ?? $("#argWidth").value);
        } else if (ast.pattern.kind === "checker") {
          $("#argCellWidth") &&
            ($("#argCellWidth").value =
              ast.pattern.cellWidth ?? $("#argCellWidth").value);
          $("#argCellHeight") &&
            ($("#argCellHeight").value =
              ast.pattern.cellHeight ?? $("#argCellHeight").value);
        } else if (ast.pattern.kind === "gradient") {
          $("#argDirection") &&
            ($("#argDirection").value =
              ast.pattern.direction ?? $("#argDirection").value);
          $("#argIntensity") &&
            ($("#argIntensity").value =
              ast.pattern.intensity ?? $("#argIntensity").value);
        }
      }

      function applyPresetToDSL() {
        updating = "form";
        const code = buildDSLFromForm();
        src.value = code;
        tryRender();
        updating = null;
      }

      const editorToForm = debounce(() => {
        if (updating) return;
        updating = "editor";
        const ast = parseDSL(src.value || "");
        setFormFromAST(ast);
        tryRender();
        updating = null;
      }, 80);

      // wire generic preset inputs
      [
        "#team",
        "#player",
        "#font",
        "#sponsor",
        "#number",
        "#player_size",
        "#number_size",
        "#team_size",
        "#sponsor_size",
        "#player_x",
        "#player_y",
        "#number_x",
        "#number_y",
        "#team_x",
        "#team_y",
        "#sponsor_x",
        "#sponsor_y",
      ].forEach((sel) => {
        const el = document.querySelector(sel);
        if (el)
          el.addEventListener("input", () => {
            applyPresetToDSL();
          });
      });

      $("#applyPreset").onclick = applyPresetToDSL;
      $("#renderBtn").onclick = () => tryRender();

      const EXAMPLE = `jersey {
        primary: #E5A823;
        secondary: #0055A2;
        tertiary: #ffffff;
        pattern_color: #0055A2;
        font: "Sport Scholars Outline";
        team: "Spartan FC", (365, 190), 18;
        player: "BEN", (365, 85), 26;
        number: 23, (365, 155), 75;
        sponsor: "SJSU", (115, 125), 35;
        pattern: stripes(7,22);
      }`;

      $("#exampleBtn").onclick = () => {
        src.value = EXAMPLE;
        editorToForm();
      };

      // Editor input -> Presets + Preview
      src.addEventListener("input", editorToForm);

      function tryRender() {
        err.textContent = "";
        fetch("/api/render", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ source: src.value }),
        })
          .then((r) => r.json())
          .then((j) => {
            if (!j.ok) {
              err.textContent = j.error || "Unknown error";
              preview.innerHTML = "";
              return;
            }
            const blob = new Blob([j.svg], { type: "image/svg+xml" });
            const url = URL.createObjectURL(blob);
            preview.innerHTML = `<object data="${url}" type="image/svg+xml" style="width:100%;height:100%"></object>`;
            preview.dataset.url = url;
          })
          .catch((e) => (err.textContent = String(e)));
      }

      $("#downloadSvg").onclick = () => {
        const url = preview.dataset.url;
        if (!url) return;
        const a = document.createElement("a");
        a.href = url;
        a.download = "jersey.svg";
        a.click();
      };

      // initial load: preset -> DSL -> render (no loop)
      updating = "form";
      src.value = buildDSLFromForm();
      tryRender();
      updating = null;
    </script>

    <script>
      // ---- AI Jersey Chat ----
      const aiMessageEl = $("#ai-message");
      const aiStatusEl = $("#ai-status");
      const aiSuggestionTextEl = $("#ai-suggestion-text");
      const aiBtnEl = $("#ai-generate-btn");

      async function callAiChatJersey() {
        const message = aiMessageEl.value.trim();

        if (!message) {
          aiStatusEl.textContent = "Please describe your jersey idea first.";
          return;
        }

        aiStatusEl.textContent = "Thinking...";
        aiBtnEl.disabled = true;
        aiBtnEl.textContent = "Generating...";

        // clear old suggestion
        aiSuggestionTextEl.textContent = "";

        try {
          const res = await fetch("/api/ai/chat-jersey", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              prompt: message,
              currentDsl: src.value || "",
            }),
          });

          let data;
          try {
            data = await res.json();
          } catch (e) {
            throw new Error("Invalid JSON from server");
          }

          console.log(data);

          if (!data.ok) {
            throw new Error(data.error || "AI could not generate a jersey.");
          }

          // Update editor & preview via DSL
          if (data.dsl) {
            src.value = data.dsl;
            editorToForm();
          }

          // Build a single natural-language sentence for the user
          if (data.spec) {
            const s = data.spec;
            const parts = [];

            if (s.team) {
              parts.push(`AI created a jersey for ${s.team}`);
            } else {
              parts.push("AI created a new jersey");
            }

            if (s.player && s.number != null) {
              parts.push(`featuring ${s.player} #${s.number}`);
            } else if (s.player) {
              parts.push(`featuring ${s.player}`);
            }

            if (s.sponsor) {
              parts.push(`with ${s.sponsor} as the main sponsor`);
            }

            const colorBits = [];
            if (s.primary) colorBits.push(`primary color ${s.primary}`);
            if (s.secondary) colorBits.push(`secondary color ${s.secondary}`);
            if (s.tertiary) colorBits.push(`tertiary accent ${s.tertiary}`);
            if (s.pattern_color)
              colorBits.push(`pattern color ${s.pattern_color}`);

            if (colorBits.length > 0) {
              parts.push("using " + colorBits.join(", "));
            }

            if (s.pattern && s.pattern.type) {
              const argsText = Array.isArray(s.pattern.args)
                ? s.pattern.args.join(", ")
                : "";
              if (argsText) {
                parts.push(`and a ${s.pattern.type} pattern (${argsText})`);
              } else {
                parts.push(`and a ${s.pattern.type} pattern`);
              }
            }

            if (s.font) {
              parts.push(`set in the "${s.font}" font`);
            }

            let sentence = parts.join(", ");
            if (!sentence.endsWith(".")) sentence += ".";

            if (data.approximationNote) {
              sentence += " " + data.approximationNote;
            }

            aiSuggestionTextEl.textContent = sentence;
          } else {
            aiSuggestionTextEl.textContent =
              "AI generated a new jersey design and updated the editor.";
          }

          aiStatusEl.textContent = "Done ✔";
        } catch (err) {
          console.error(err);
          aiStatusEl.textContent = "Error: " + err.message;
          aiSuggestionTextEl.textContent = "";
        } finally {
          aiBtnEl.disabled = false;
          aiBtnEl.textContent = "Generate from AI";
        }
      }

      aiBtnEl.addEventListener("click", callAiChatJersey);
    </script>

    <div class="site-footer">
      © 2025 Ben Nguyen — Procedural Jersey Generator
    </div>
  </body>
</html>
